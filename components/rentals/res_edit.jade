template(name='reservation_edit')
    with current_doc
        .ui.stackable.padded.grid
            .three.column.row
                .column 
                    a.ui.big.fluid.basic.button(href="/reservation/#{_id}/view" title='save')
                        //- i.checkmark.large.green.icon
                        +i name='submit-progress--v1'        
                        .ui.inline.header save draft     
                    .ui.hidden.divider     
                    .ui.large.fluid.icon.button.cancel_reservation
                        i.ban.icon
                        |cancel
                    .ui.header 
                        strong #{rental.title}
                        small reservation
                    with rental
                        .ui.inline.header $#{hourly_dollars}
                            small /hr
                        |&nbsp;
                        |&nbsp;
                        .ui.inline.header $#{daily_dollars}
                            small /day
                        +image_view key='image' label='image' direct=true classes='ui rounded image'
                    .result_column        
                        .ui.header 
                            +i name='payroll'
                            small 50% owner
                            |$#{owner_payout} to #{rental.owner_username}
                        .ui.header.handler
                            +i name='get-cash'
                            small 45% handler
                            | $#{handler_payout} to #{rental.handler_username}
                        div
                        .ui.header 
                            +i name='tax'
                            small 5% taxes
                            | $#{taxes_payout}
                
                .column 
                    a.ui.header(href="/rental/#{rental._id}/view") reserve #{rental.title}
                    .ui.fluid.button.reserve_now(class=now_button_class)
                        +i name='present'
                        |reserve now
                    unless now
                        .ui.header 
                            +i name='date-to' classes='ui tiny inline image'
                            |start date/time
                        .ui.input
                            //- input.res_start(type='datetime-local' value=start_datetime)
                            input.res_start(type='datetime-local' value="#{start_datetime}")
                        //- +datetime_edit key='start_datetime' label='start datetime' direct=true
                    if start_datetime
                        .ui.header 
                            |duration
                        div
                        .ui.input            
                            input.other_hour(type='number' min='0' value=hour_duration autocomplete="off")
                        .ui.header 
                            +i name='date-from'    
                            |end date/time            
                        .ui.input
                            input.res_end(type='datetime-local' value="#{end_datetime}")
                .column.result_column.rounded
                    if start_datetime
                        .ui.header.lowercase 
                            small from 
                            |{{cal_time start_datetime}}
                        if end_datetime
                            .ui.header.lowercase 
                                small to
                                |{{cal_time end_datetime}}
                            .ui.header 
                                +i name='money' classes='ui tiny inline image'
                                | #{hour_duration}
                                small hrs * $
                                |#{rental.hourly_dollars}
                                small /hr = $
                                |#{cost}
                            if rental.res_start_dropoff
                                |reservation start dropoff available for $#{rental.res_start_dropoff_fee} extra
                                +boolean_edit key='res_start_dropoff_selected' classes='trigger_recalc' label='select start dropoff' direct=true data=this._id  
                            div
                            if rental.res_end_pickup
                                |reservation end pickup available for $#{rental.res_end_pickup_fee} extra
                                +boolean_edit key='res_end_pickup_selected' classes='trigger_recalc' label='select end pickup' direct=true data=this._id
                            .ui.divider
                            .ui.header 
                                small your balance
                                +i name='coins' 
                                |{{fixed currentUser.credit}} 
                            .ui.header.result
                                |deductions
                                | -  #{cost} 
                                if res_start_dropoff_selected
                                    | + #{rental.res_start_dropoff_fee}
                                if res_end_pickup_selected
                                    | + #{rental.res_end_pickup_fee}
                            .ui.header.result
                                |balance after purchase
                                small = 
                                //- small balance after purchase 
                                +i name='coins' 
                                |#{member_balance_after_reservation}
                        
                        
                    unless submitted
                        .ui.big.green.fluid.button.submit_reservation(class=submit_button_class)
                            +i name='paid'        
                            |submit and pay
                    else
                        .ui.header submitted {{ from_now submitted_timestamp }}
                        .ui.orange.fluid.button.unsubmit
                            i.undo.icon
                            |unsubmit
